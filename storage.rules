rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    // User avatars
    match /avatars/{userId}/{fileName} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == userId;
    }
    
    // User media uploads
    match /uploads/{userId}/{fileName} {
      allow read: if request.auth != null && 
        (request.auth.uid == userId || 
         request.auth.token.role == 'admin');
      allow write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Creator content
    match /content/{creatorId}/{fileName} {
      allow read: if request.auth != null && 
        (request.auth.uid == creatorId || 
         request.auth.token.role == 'admin' ||
         // Check if user has subscription to creator
         exists(/databases/$(database)/documents/subscriptions/$(request.auth.uid + '_' + creatorId)));
      allow write: if request.auth != null && 
        (request.auth.uid == creatorId || 
         request.auth.token.role == 'admin');
    }
    
    // Public content
    match /public/{fileName} {
      allow read: if true;
      allow write: if request.auth != null && 
        request.auth.token.role == 'admin';
    }
    
    // Thumbnails
    match /thumbnails/{fileName} {
      allow read: if true;
      allow write: if request.auth != null && 
        request.auth.token.role == 'admin';
    }
    
    // Temporary uploads
    match /temp/{userId}/{fileName} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Admin uploads
    match /admin/{fileName} {
      allow read, write: if request.auth != null && 
        request.auth.token.role == 'admin';
    }
    
    // System files
    match /system/{fileName} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && 
        request.auth.token.role == 'admin';
    }
    
    // Backup files
    match /backups/{fileName} {
      allow read, write: if request.auth != null && 
        request.auth.token.role == 'admin';
    }
    
    // Logs
    match /logs/{fileName} {
      allow read, write: if request.auth != null && 
        request.auth.token.role == 'admin';
    }
  }
}
